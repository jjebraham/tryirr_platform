{# core/templates/core/dashboard.html #}
{% extends "core/base.html" %}
{% load i18n %}

{% block title %}{% trans "Dashboard" %}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">

  <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-8">
    {% trans "Dashboard" %}
  </h1>

  <div class="mb-6 p-4 bg-white dark:bg-gray-800 rounded-lg shadow">
    <p class="text-gray-700 dark:text-gray-300">
      {% trans "Verification Level:" %} {{ request.user.kyc_level }}
      {% if request.user.kyc_level < 1 %}
        - <a href="{% url 'core:kyc_wizard' %}" class="text-blue-600 dark:text-blue-400 hover:underline">{% trans "Verify now" %}</a>
      {% endif %}
    </p>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Exchange Rates Card -->
    <div class="card">
      <div class="card-header">
        <h2 class="text-xl font-semibold">
          {% trans "Exchange Rates" %}
        </h2>
      </div>
      <div class="p-4">
        <table id="live-rates-table" class="w-full text-sm">
          <thead>
            <tr>
              <th class="text-left">Pair</th>
              <th class="text-right">Rate</th>
            </tr>
          </thead>
          <tbody>
            {% if rates.TRY_IRR %}
            <tr>
              <td>1 TRY → IRR</td>
              <td class="text-right" id="rate-try-irr">{{ rates.TRY_IRR|floatformat:2 }}</td>
            </tr>
            <tr>
              <td>1 IRR → TRY</td>
              <td class="text-right" id="rate-irr-try">{{ rates.IRR_TRY|floatformat:6 }}</td>
            </tr>
            {% else %}
            <tr>
              <td colspan="2" class="text-center text-red-500">{% trans "Unable to fetch live rates right now." %}</td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
      <script>
        async function fetchRates() {
          try {
            const resp = await fetch("{% url 'core:live_rates' %}");
            if (!resp.ok) return;
            const data = await resp.json();
            if (data.TRY_IRR !== null) {
              document.getElementById("rate-try-irr").textContent = Number(data.TRY_IRR).toFixed(2);
              document.getElementById("rate-irr-try").textContent = Number(data.IRR_TRY).toFixed(6);
            }
          } catch (e) {
            console.error(e);
          }
        }
        setInterval(fetchRates, 10000);
      </script>
    </div>

    <!-- Your Balances Card -->
    <div class="card">
      <div class="card-header">
        <h2 class="text-xl font-semibold">
          {% trans "Your Balances" %}
        </h2>
      </div>
      <div class="p-4">
        <p class="text-gray-600 dark:text-gray-400">
          {% trans "Coming soon…" %}
        </p>
      </div>
    </div>
  </div>

  <!-- Instant Converter Card -->
  <div class="card mb-8">
    <div class="card-header">
      <h2 class="text-xl font-semibold">
        {% trans "Instant Converter" %}
      </h2>
    </div>
    <div class="p-4">
      <form method="get" class="flex flex-wrap items-end gap-4">
        <div class="flex-1 min-w-[120px]">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            {% trans "Convert:" %}
          </label>
          {{ conversion_form.direction }}
        </div>
        <div class="flex-1 min-w-[120px]">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            {% trans "Amount:" %}
          </label>
          {{ conversion_form.amount }}
        </div>
        <div>
          <button type="submit" class="btn-primary">
            {% trans "Convert" %}
          </button>
        </div>
        {% if conversion_result is not None %}
          <div class="w-full mt-4">
            <p class="text-lg font-medium text-gray-900 dark:text-gray-100">
              {% trans "Result:" %} 
              {{ conversion_result|floatformat:2 }}
            </p>
          </div>
        {% endif %}
      </form>
    </div>
  </div>

</div>
{% endblock %}

