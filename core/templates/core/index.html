{% extends "core/base.html" %}
{% load i18n %}

{% block title %}{% trans "Welcome" %} — TL/IRR Exchange{% endblock %}

{% block content %}
  <div class="min-h-screen flex flex-col items-center justify-center bg-gray-100">

    <h1 class="text-5xl font-bold mb-8">{% trans "TL/IRR Exchange" %}</h1>
    <div class="space-x-4">

      {% if user.is_authenticated %}
        <a href="{% url 'core:dashboard' %}"
           class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
          {% trans "Go to Dashboard" %}
        </a>

        <a href="{% url 'core:kyc' %}"
           class="px-6 py-3 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">      

          {% trans "Verify Account" %}
        </a>
      {% else %}
        <a href="{% url 'account_signup' %}"
           class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700">        
          {% trans "Sign Up" %}
        </a>
        <a href="{% url 'account_login' %}"
           class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
          {% trans "Log In" %}
        </a>
        <a href="{% url 'core:kyc' %}"
           class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700">      
          {% trans "Verification Center" %}
        </a>
      {% endif %}
    </div>

    <div class="w-full max-w-xl bg-white rounded-lg shadow p-4">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-xl font-semibold">{% trans "Live Rates" %}</h2>
        <div class="text-sm text-gray-500">
          <span id="countdown">10:00</span>
        </div>
      </div>
      <table class="w-full text-sm text-left text-gray-700">
        <thead>
          <tr class="bg-gray-100">
            <th class="px-2 py-1">{% trans "Operation" %}</th>
            <th class="px-2 py-1">{% trans "Rate" %}</th>
          </tr>
        </thead>
        <tbody id="rates-body">
          <tr><td class="px-2 py-1" colspan="2">{% trans "Loading…" %}</td></tr>
        </tbody>
      </table>
      <div class="text-right mt-2">
        <button id="refresh-btn" class="px-3 py-1 bg-blue-600 text-white rounded">{% trans "Refresh" %}</button>
      </div>
    </div>
  </div>

  <script>
    const COUNTDOWN_SECS = 600;
    let remaining = COUNTDOWN_SECS;

    async function fetchRates() {
      try {
        const r = await fetch('{% url "core:rates" %}');
        if (!r.ok) throw new Error('network');
        const data = await r.json();
        const body = document.getElementById('rates-body');
        body.innerHTML = '';
        const items = [
          ['{% trans "Buy TRY from us" %}', data.buy_lira + ' تومان'],
          ['{% trans "Sell TRY to us" %}', data.sell_lira + ' تومان'],
          ['{% trans "Buy USDT from us" %}', data.buy_usdt + ' تومان'],
          ['{% trans "Sell USDT to us" %}', data.sell_usdt + ' تومان'],
          ['{% trans "TRY to USDT" %}', data.try_to_usdt + ' TRY'],
          ['{% trans "USDT to TRY" %}', data.usdt_to_try + ' TRY'],
        ];
        for (const [op, rate] of items) {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td class="px-2 py-1">${op}</td><td class="px-2 py-1">${rate}</td>`;
          body.appendChild(tr);
        }
      } catch (e) {
        document.getElementById('rates-body').innerHTML = '<tr><td class="px-2 py-1" colspan="2">{% trans "Error loading rates" %}</td></tr>';
      }
    }

    function updateCountdown() {
      remaining--;
      if (remaining <= 0) {
        fetchRates();
        remaining = COUNTDOWN_SECS;
      }
      const m = String(Math.floor(remaining / 60)).padStart(2, '0');
      const s = String(remaining % 60).padStart(2, '0');
      document.getElementById('countdown').textContent = m + ':' + s;
    }

    document.getElementById('refresh-btn').addEventListener('click', () => {
      remaining = COUNTDOWN_SECS;
      fetchRates();
    });

    fetchRates();
    setInterval(updateCountdown, 1000);
  </script>
{% endblock %}

